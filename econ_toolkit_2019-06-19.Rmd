---
title: "The Applied Economist's Toolkit"
subtitle: ""  
author: "Wei Yang Tham"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center', warning = FALSE, message = FALSE, eval = TRUE)

library(tidyverse)
library(magrittr)

```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)

# solarized_dark(
#   code_font_family = "Fira Code",
#   code_font_url    = "https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css"
# )


duo(
  primary_color = "#fcedd1",
  secondary_color = "#2a488e",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Droid Mono"),
  text_font_size = "25px"
)

write_extra_css(list("strong" = list("font-weight" = "bold", "color" = "#d33682")))

theme_wyt <- function(base_size = 11, base_family = "", base_line_size = base_size/22, base_rect_size = base_size/22){
  # theme_light() %+replace%
  ggthemes::theme_fivethirtyeight(base_size = base_size,
                                  base_family = base_family) %+replace%
    theme(
      plot.background = element_rect(fill = "#fcedd1", colour = "#fcedd1"),
      panel.background = element_rect(fill = "#fcedd1", colour = "#fcedd1"),
      title = element_text(colour = "black"),
      axis.title = element_text(), 
      legend.background = element_rect(fill = "#fcedd1"), 
      legend.key = element_rect(fill = "#fcedd1")
    )
}
theme_set(theme_wyt(base_size = 13))

```

```{r}
rm(list = ls())
library(tidyverse)
library(magrittr)
theme_set(theme_minimal(base_size = 13))
```

# About Me
  
Finishing my PhD in Economics at The Ohio State University

Economics of science and innovation

R, dataviz, causal inference

--

Improv at [The Nest Theatre](https://nesttheatre.com/)

--- 

# Goals

Provide intuition for "methods" that economists have been using

Inspiration for ways you might apply this in the context you work in

---

# Caveats

Lots of advances in methodology have come from other fields including political science, epidemiology, statistics, computer science

Only one part of econometrics and economics

---

class: centre, middle

# Data scientists wear many hats

```{r, out.width="45%", fig.align='default'}
knitr::include_graphics(c("img/beta_hat.png", "img/y_hat.jpg"))

```

---

## Prediction vs causation


## $$y = X_1\beta_1 + \epsilon$$
---

$\hat{y}$ - If a student with a certain set of characteristics $X_i$ (e.g. test scores, demographics) arrives, what is my best guess of their future wages?

$\hat{\beta}$ - If I implement an educational intervention, what is my best guess of how much their wages will increase?

--

Estimating $\hat{\beta}$ is the bread and butter of many applied economists 

---

Why can't we just run a regression of $y$ on $X$?

---

## People don't make choices randomly

E.g. people don't randomly choose whether to go to college 

---

## Threats to validity

Omitted variable bias - people make choices to 

Reverse causation - Umbrellas cause rain


---

## Randomized experiments are often treated as the gold standard

---

## But RCTs are not always feasible

- Feasibility or expense
- Ethics

---

Which is where quasi-experiments come in

---

## Quasi-experimental designs

- Instrumental variables
- Difference-in-differences
  + Synthetic control
- Matching
- Regression discontinuity


---

# Design vs methods

- Focus is on *credible* design
- Advantages: assumptions are transparent, focuses the discussion

---
class: middle, inverse

The applied economist's toolkit

---

## Instrumental variables

- Can address confounding and reverse causality

---

```{r}
knitr::include_graphics("img/iv_dag.png")
```

---

## What makes a good instrument?

- Relevant 
- Has an effect on the intervention

- Exclusion restriction
- Only related to the outcome through its effect on intervention

---

## Where to find instruments

- Gender of children as instrument for family size
- Quarter-of-birth for years spent in school
- Muslim holidays as instrument for number of drivers on the road
- **Randomization** is a great instrument - e.g. Oregon medicaid lottery

---

## A/B tests can be instruments too!
  

---

### If you run A/B tests you have instruments too!

Example

---

## Difference-in-differences accounts for underlying time trends

- When you observe a group over multiple periods of time
- Commonly used to compare policy changes across cities or states

---

```{r dd_plots}

set.seed(1)
n <- 10 ^ 3

simulatedError <- rnorm(n = n)
group <- sample(c(T, F), n, replace = TRUE)

df <- tibble(time = 10 * round(runif(n), 1) - 5,
                 treatment = group,
                 error = simulatedError)

df %<>%
    mutate(Y = 1 + time + 5 * treatment + 7 * (time >= 0) * treatment + error)

# fit <- lm(Y ~ time + treatment + I((time >= 0) * treatment), data = df)
# summary(fit)

dfmean <- df %>%
    group_by(time, treatment) %>%
    summarise(Y = mean(Y))

df %<>% 
  mutate(g = case_when(
    treatment & time < 0 ~ 1, 
    treatment & time >= 0 ~ 2, 
    !treatment & time < 0 ~ 3, 
    !treatment & time >= 0 ~ 4
  ))

ggplot(data = df, 
       aes(x = time, y = Y, 
           colour = treatment, 
           group = g
           )
       ) + 
  geom_point() + 
  geom_smooth(method = lm, se = FALSE) + 
  theme(legend.position = "none") + 
  scale_color_manual(values = c("#F05253", "#2A73CC", "#F05253", "#2A73CC"))
```

---

## Difference-in-differences relies on the parallel trend assumption

```{r}

dd_counterfac = df %>% 
  filter(treatment, time >= 0) %>% 
  mutate(Y = Y - 7)

ggplot(data = df, 
       aes(x = time, y = Y, 
           colour = treatment, 
           group = g
           )
       ) + 
  geom_smooth(data = dd_counterfac, 
              aes(x = time, y = Y), 
              colour = "grey", se = FALSE, method = "lm") + 
  geom_smooth(method = lm, se = FALSE) + 
  theme(legend.position = "none") + 
  scale_color_manual(values = c("#F05253", "#2A73CC", "#F05253", "#2A73CC"))

```


---

Classic example: Card and Krueger (1993)

- Compared employment in New Jersey and Pennsylvania before and after minimum wage was raised in New Jersey

---

## Effectiveness of Search Engine Marketing (SEM)

---

## Synthetic Control is a close cousin of difference-in-differences

Used in comparative case studies - how did an event affect aggregate outcomes of a single unit (e.g. country, state)?

Example: What was the economic impact of reunification on West Germany?

---

## Synthetic control finds the weighted combination of countries that are most similar to Germany

- Minimize the distance between West Germany and potential control countries based on a set of pre-unification variables 

--- 

## West Germany looks different from the rest of the OECD

---

## West Germany and Synthetic West Germany look similar pre-reunification

---

## Synthetic Control: How can you measure the impact of TV advertising?

- Can't randomly assign TV ads to individual users
- Instead, randomly assign treatment to cities 

---

## Two issues with randomizing by geographic area

1. There are a limited number of cities and they are very different from each other
2. If you divide up the US into treatment and control, then you can't estimate the effect for *entire* US

---

## Create synthetic US for both treated *and* control cities

.center2[
```{r}
knitr::include_graphics("img/wayfair_syntheticcontrol.png")
```
]

---

## Regression discontinuity

- Compare units just above or below an arbitrary/random cutoff 
- E.g. test scores to get a scholarship

---

```{r}

mu <- matrix(c(0, 0))
rho <- 0.5
sigma1 <- 0.5
sigma2 <- 2
Sigma <- matrix(c(sigma1 ^ 2, 
                  rho * sigma1 * sigma2, 
                  rho * sigma1 * sigma2, 
                  sigma2 ^ 2),
                c(2, 2))

simulatedXandC <- MASS::mvrnorm(n = n, mu = mu, Sigma = Sigma)


df <- tibble(X = simulatedXandC[, 1],
                 C = simulatedXandC[, 2],
                 tee = (simulatedXandC[, 1] > 0),
                 error = simulatedError)

df %<>%
    mutate(Y = 10 + X ^ 3 + 5 * tee + 1 * C + error)

ggplot(data = df, aes(x = X, y = Y, color = (X > 0))) + 
  geom_point(alpha = 0.8) +
  geom_smooth(method = lm,   
                se = FALSE) + 
  annotate(geom = "rect", 
           xmin = -0.1, xmax = 0.1, ymax = 15, ymin = 10, 
           fill = NA, colour = "black")

```

---

## Regression discontinuity doesn't work if units around threshold are not randomly assigned

- There could be manipulation around the threshold e.g. influential parents lobby to get their children extra points if they're just below the threshold

---

## Validity Checks

1. Look at distribution of units around the threshold

2. Look at distribution of observables around the threshold

---

## #Units above threshold $\approx$ #Units below threshold

```{r}

df %>% 
  ggplot(aes(x = X)) + 
  geom_histogram(breaks = seq(-2, 2, 0.5), colour="white", fill = "#00B39F") + 
  geom_vline(xintercept = 0, linetype = 2, size = 1.3) + 
  labs(title = "No manipulation") 



```

---

```{r}
df %>%
  mutate(rand = runif(n()),
         X = ifelse(rand < 0.33 & X < 0, -X, X)) %>%
  ggplot(aes(x = X)) + 
  geom_histogram(breaks = seq(-2, 2, 0.5), colour="white", fill = "#00B39F") + 
  geom_vline(xintercept = 0, linetype = 2, size = 1.3) + 
  labs(title = "Manipulation - Unusual jump at threshold")

```

---



---

## What can't quasi-experiments do

- Experiment you want vs experiment you get
- Local average treatment effects
- External validity

---

## Econometrics and Machine Learning

---

# Resources 

- Mostly Harmless Econometrics or Mastering 'Metrics
- [What's the Science in Data Science? - Skipper Seabold](https://youtu.be/kTo16ieMCi8)
- [Teconomics](https://medium.com/teconomics-blog/)
- [Wayfair Tech Blog](https://tech.wayfair.com/data-science/2017/08/using-geographic-splitting-optimization-techniques-to-measure-marketing-performance/)






